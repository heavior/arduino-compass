<!DOCTYPE html>
<html>
  <head>

    <script src="http://cdn.jsdelivr.net/npm/protobufjs@7.X.X/dist/protobuf.min.js"></script>
    <title>BLE Compass</title>
    <style>
        body {
          font-family: Arial, sans-serif;
        }
        .data-row {
          display: flex;
          justify-content: space-between;
          padding: 5px 0;
          border-bottom: 1px solid #ddd;
        }
        .data-row:last-child {
          border-bottom: none;
        }
        .data-key {
          font-weight: bold;
        }
      </style>

    <script>
      let compassServiceUUID = "19b10000-e8f2-537e-4f6c-d104768a1214";
      let compassStateUUID = "19b10001-e8f2-537e-4f6c-d104768a1214";
      let compassConfigUUID = "55c3d0bf-d6d5-47f5-9222-650e7249b6f6";
      let calibrationServiceUUID = "66c41382-675a-4ec8-af51-82456e148c79";

      let device, server, service, stateCharacteristic, configCharacteristic;
      let CompassConfig, compassData;
      async function connect() {
        // Load the .proto file
        compassData = await protobuf.load("compassData.proto");

        // Obtain a message type
        CompassConfig = compassData.lookupType("CompassConfig");
        CompassState = compassData.lookupType("CompassState");


        try {
          console.log('Requesting Bluetooth Device...');
          device = await navigator.bluetooth.requestDevice({
            filters: [{ services: [calibrationServiceUUID] }],
            optionalServices: [compassServiceUUID]
          });

          console.log('Connecting to GATT Server...');
          server = await device.gatt.connect();

          console.log('Getting Compass Service...');
          service = await server.getPrimaryService(compassServiceUUID);

          console.log('Getting Compass State Characteristic...');
          stateCharacteristic = await service.getCharacteristic(compassStateUUID);
          configCharacteristic = await service.getCharacteristic(compassConfigUUID);


          await stateCharacteristic.startNotifications();
          await configCharacteristic.startNotifications();

          stateCharacteristic.addEventListener('characteristicvaluechanged', handleStateCharacteristicValueChanged);
          configCharacteristic.addEventListener('characteristicvaluechanged', handleConfigCharacteristicValueChanged);

          console.log('Connected!');
        } catch (error) {
          console.error('Error: ', error);
        }
      }

        async function parseCompassConfig(buffer) {
            // Decode the message
            const uintbuffer = (new Uint8Array(buffer.buffer));
            const message = await CompassConfig.decode(uintbuffer);
            const value = await CompassConfig.toObject(message);

            console.log("compass config",value);
            return value;
        }

        function uint8ArrayToBase64(uint8Array) {
          let binary = '';
          const length = uint8Array.length;

          for (let i = 0; i < length; i++) {
            binary += String.fromCharCode(uint8Array[i]);
          }

          return btoa(binary);
        }

        async function parseCompassState(buffer) {
            // Decode the message
            const uintbuffer = (new Uint8Array(buffer.buffer));
//            console.log("buffer uint array", uintbuffer.join(','));
//            console.log("buffer uint array base64", uint8ArrayToBase64(uintbuffer));
            
            const message = await CompassState.decode(uintbuffer);
            const value = await CompassState.toObject(message);

//            console.log("message",message);
            console.log("cmopass state value",value);
            return value;
        }



      async function handleConfigCharacteristicValueChanged(event) {
        let value = event.target.value;
        let compassConfig = await parseCompassConfig(value);
        updateDisplay("compassConfig",compassConfig);
      }


      async function handleStateCharacteristicValueChanged(event) {
        let value = event.target.value;
        let compassState = await parseCompassState(value);
        updateDisplay("compassState",compassState);
      }

      function updateDisplay(htmlid, compassState) {
        console.log(htmlid, compassState);
        let container = document.getElementById(htmlid);
        container.innerHTML = '';  // Clear previous data
        for (let key in compassState) {
          let row = document.createElement('div');
          row.className = 'data-row';
          let keySpan = document.createElement('span');
          keySpan.className = 'data-key';
          keySpan.textContent = key + ':';
          let valueSpan = document.createElement('span');
          valueSpan.textContent = JSON.stringify(compassState[key]);
          row.appendChild(keySpan);
          row.appendChild(valueSpan);
          container.appendChild(row);
        }
      }
      /*function parseCompassState(data) {
            let compassState = {
                //
//8 16 17 18 22 26 30 34 38 42 46 50 51 52 56 57 57 
                lattitude: data.getFloat64(0, true),
                longtitude: data.getFloat64(8, true),
                havePosition: !!data.getUint8(16),
                closed: !!data.getUint8(17),
                servoSpeed: data.getInt32(18, true),
                heading: data.getInt32(22, true),
                dial: data.getInt32(26, true),
                batteryVoltage: data.getFloat32(30, true),
                batteryLevel: data.getInt32(34, true),
                destination: [
                    data.getFloat64(38, true),
                    data.getFloat64(46, true)
                ],
                direction: data.getFloat32(54, true),
                distance: data.getFloat32(58, true),
                disableMotor: !!data.getUint8(62),
                spinMotor: !!data.getUint8(63),
                spinSpeed: data.getInt16(64, true),
                calibrate: !!data.getUint8(68),
                calibrateTarget: data.getInt16(69, true),
            };

            return compassState;
        }*/



      function disconnect() {
        if (!device) {
          console.log('no device');
          return;
        }
        console.log('Disconnecting from Bluetooth Device...');
        if (device.gatt.connected) {
          device.gatt.disconnect();
        } else {
          console.log('Bluetooth Device is already disconnected');
        }
      }
    </script>
  </head>
  <body>
    <h1>Status</h1><br>
    <a href="index.html">Calibration</a>
    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()">Disconnect</button>
    <h2>Compass State</h2>
    <p id="compassState"></p>

    <h2>Compass Config</h2>
    <p id="compassConfig"></p>
  </body>
</html>
